# InternalTicketUsageService ì‚¬ìš© ê°€ì´ë“œ

> ë‚´ë¶€ ì •ê¸°ê¶Œ ë™/í˜¸ìˆ˜ë³„ ì‚¬ìš©ëŸ‰ ì¡°íšŒ ì„œë¹„ìŠ¤

------

## ğŸ“¦ ìœ„ì¹˜

```
CommonModule/src/main/java/com/akc/b2c/common/service/InternalTicketUsageService.java
```

---

## ğŸ”§ ì£¼ì… ë°©ë²•

```java
import com.akc.b2c.common.service.InternalTicketUsageService;
import com.akc.b2c.common.dto.InternalTicketUsageDto;

@Service
public class YourService {
    
    @Autowired
    private InternalTicketUsageService internalTicketUsageService;
}
```

---

## ğŸ“‹ ì œê³µ ë©”ì„œë“œ

### 1. ì •ê¸°ê¶Œë³„ ë™/í˜¸ìˆ˜ ì‚¬ìš©ëŸ‰ ì „ì²´ ì¡°íšŒ

```java
List<InternalTicketUsageDto> getUsageByTicket(String plotId, String gdsId)
```

| íŒŒë¼ë¯¸í„° | ì„¤ëª… |
|---------|------|
| `plotId` | ì£¼ì°¨ì¥ ID |
| `gdsId` | ì •ê¸°ê¶Œ ID |

**ë°˜í™˜ê°’**: ë™/í˜¸ìˆ˜ë³„ í™œì„± ì°¨ëŸ‰ ìˆ˜ ëª©ë¡

---

### 2. íŠ¹ì • ë™/í˜¸ìˆ˜ ì‚¬ìš©ëŸ‰ ì¡°íšŒ

```java
Long getUsageByUnit(String plotId, String gdsId, String buildingDong, String unitNumber)
```

| íŒŒë¼ë¯¸í„° | ì„¤ëª… |
|---------|------|
| `plotId` | ì£¼ì°¨ì¥ ID |
| `gdsId` | ì •ê¸°ê¶Œ ID |
| `buildingDong` | ê±´ë¬¼ ë™ (ì˜ˆ: "1001") |
| `unitNumber` | í˜¸ìˆ˜ (ì˜ˆ: "101") |

**ë°˜í™˜ê°’**: í•´ë‹¹ ë™/í˜¸ìˆ˜ì˜ í™œì„± ì°¨ëŸ‰ ìˆ˜

---

## ğŸ“ DTO êµ¬ì¡°

```java
public class InternalTicketUsageDto {
    private String buildingDong;   // ë™
    private String unitNumber;     // í˜¸ìˆ˜
    private Long usedCount;        // ì‚¬ìš©ì¤‘ì¸ ì°¨ëŸ‰ ìˆ˜
}
```

---

## ğŸ’¡ ì‚¬ìš© ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ì •ê¸°ê¶Œì˜ ì „ì²´ ë™/í˜¸ìˆ˜ë³„ ì‚¬ìš©ëŸ‰ ì¡°íšŒ

```java
// ë‚´ë¶€ ì •ê¸°ê¶Œ ìƒí’ˆì˜ ë™/í˜¸ìˆ˜ë³„ ì‚¬ìš© í˜„í™© ì¡°íšŒ
List<InternalTicketUsageDto> usageList = 
    internalTicketUsageService.getUsageByTicket("02343", "RC00010347");

// Mapìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹ ë¥¸ ì¡°íšŒ
Map<String, Long> usageMap = usageList.stream()
    .collect(Collectors.toMap(
        u -> u.getBuildingDong() + "-" + u.getUnitNumber(),
        InternalTicketUsageDto::getUsedCount
    ));

// íŠ¹ì • ë™/í˜¸ìˆ˜ì˜ ì‚¬ìš©ëŸ‰ ì¡°íšŒ
String key = "101ë™-101í˜¸";
long usedCount = usageMap.getOrDefault(key, 0L);  // ì—†ìœ¼ë©´ 0
```

### ì˜ˆì‹œ 2: êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚°

```java
// í•´ë‹¹ ë™/í˜¸ìˆ˜ì˜ ì‚¬ìš©ëŸ‰ ì¡°íšŒ
Long usedCount = internalTicketUsageService.getUsageByUnit(
    "02343",        // plotId
    "RC00010347",   // gdsId
    "101ë™",        // buildingDong
    "101í˜¸"         // unitNumber
);

// êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰ ê³„ì‚°
int parkingCapacity = 3;  // regular_ticket_unitsì—ì„œ ì¡°íšŒí•œ ê°’
int availableCount = parkingCapacity - usedCount.intValue();

if (availableCount <= 0) {
    throw new IllegalStateException("êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.");
}
```

---

## âš ï¸ ìœ íš¨í•œ ì£¼ë¬¸ ì¡°ê±´

ì„œë¹„ìŠ¤ ë‚´ë¶€ì—ì„œ ì•„ë˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì£¼ë¬¸ë§Œ ì§‘ê³„í•©ë‹ˆë‹¤:

| ì¡°ê±´ | ì„¤ëª… |
|------|------|
| `payment_status = 'PAID'` | ê²°ì œ ì™„ë£Œëœ ì£¼ë¬¸ |
| `refund_status != 'COMPLETED'` | ì „ì•¡ í™˜ë¶ˆë˜ì§€ ì•Šì€ ì£¼ë¬¸ |
| `end_date >= ì˜¤ëŠ˜` | ì‚¬ìš© ê¸°ê°„ì´ ë‚¨ì€ ì£¼ë¬¸ |
| `order_cars.status IN (...)` | í™œì„± ì°¨ëŸ‰ë§Œ (REGISTERED, REFUND_REQUESTED, REFUND_REJECTED) |

---

## â“ ë¬¸ì˜

êµ¬í˜„ ì¤‘ ê¶ê¸ˆí•œ ì  ìˆìœ¼ë©´ ì‹ ì§€ì˜ˆì—ê²Œ ì—°ë½ì£¼ì„¸ìš”!
